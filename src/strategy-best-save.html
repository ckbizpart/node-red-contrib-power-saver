<script type="text/javascript">
  RED.nodes.registerType("ps-strategy-best-save", {
    category: "Power Saver",
    color: "#a6bbcf",
    defaults: {
      name: { value: "Best Save" },
      maxMinutesOff: {
        value: 180,
        required: true,
        validate: RED.validators.number(),
      },
      minMinutesOff: {
        value: 60,
        required: false,
        validate: RED.validators.number(),
      },
      recoveryPercentage: {
        value: 50,
        required: true,
        validate: RED.validators.number(),
      },
      recoveryMaxMinutes: {
        value: 120,
        required: false,
        validate: RED.validators.number(),
      },
      minSaving: {
        value: 0.01,
        required: true,
        validate: RED.validators.number(),
      },
      sendCurrentValueWhenRescheduling: {
        value: true,
        required: true,
        align: "left",
      },
      outputValueForOn: {
        value: true,
        required: true,
        validate: RED.validators.typedInput("outputValueForOntype", false),
      },
      outputValueForOff: {
        value: false,
        required: true,
        validate: RED.validators.typedInput("outputValueForOfftype", false),
      },
      outputValueForOntype: {
        value: "bool",
        required: true,
      },
      outputValueForOfftype: {
        value: "bool",
        required: true,
      },
      outputIfNoSchedule: { value: "true", required: true, align: "left" },
      contextStorage: { value: "default", required: false, align: "left" },
    },
    inputs: 1,
    outputs: 3,
    icon: "font-awesome/fa-bar-chart",
    color: "#FFCC66",
    label: function () {
      return this.name || "Best Save";
    },
    outputLabels: ["on", "off", "schedule"],
    oneditprepare: function () {
      $("#node-input-outputIfNoSchedule").typedInput({
        types: [
          {
            value: "onoff",
            options: [
              { value: "true", label: "On" },
              { value: "false", label: "Off" },
            ],
          },
        ],
      });
      $("#node-input-contextStorage").typedInput({
        types: [
          {
            value: "storages",
            options: RED.settings.context.stores.map((s) => ({ value: s, label: s })),
          },
        ],
      });
      $("#node-input-outputValueForOn").typedInput({
        default: "bool",
        typeField: $("#node-input-outputValueForOntype"),
        types: ["bool", "num", "str"],
      });
      $("#node-input-outputValueForOff").typedInput({
        default: "bool",
        typeField: $("#node-input-outputValueForOfftype"),
        types: ["bool", "num", "str"],
      });
    },
  });
</script>

<script type="text/html" data-template-name="ps-strategy-best-save">
    <div class="form-row">
        <label for="node-input-name" style="width: 200px"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width: 240px">
    </div>
    <h3>Rules</h3>
    <div class="form-row">
        <label for="node-input-maxMinutesOff" style="width: 200px"><i class="fa fa-arrows-h"></i> Max minutes off</label>
        <input type="text" id="node-input-maxMinutesOff" style="width: 80px" placeholder="Minutes">
    </div>
    <div class="form-row">
        <label for="node-input-minMinutesOff" style="width: 200px"><i class="fa fa-arrows-h"></i> Min minutes off</label>
        <input type="text" id="node-input-minMinutesOff" style="width: 80px" placeholder="Minutes">
    </div>
    <div class="form-row">
        <label for="node-input-recoveryPercentage" style="width: 200px"><i class="fa fa-ellipsis-h"></i> Recovery time %</label>
        <input type="text"
               id="node-input-recoveryPercentage"
               style="width: 80px"
               placeholder="%">
    </div>
    <div class="form-row">
      <label for="node-input-recoveryMaxMinutes" style="width: 200px"><i class="fa fa-arrows-h"></i> Max recovery time</label>
      <input type="text" id="node-input-recoveryMaxMinutes" style="width: 80px" placeholder="Minutes">
    </div>
  <div class="form-row">
        <label for="node-input-minSaving" style="width: 200px"><i class="fa fa-eur"></i> Min saving</label>
        <input type="text" id="node-input-minSaving" placeholder="Minimum to save per kWh for turning off" style="width: 80px">
    </div>
  <h3>Output</h3>
    <div class="form-row">
      <div class="form-row">
        <label for="node-input-outputValueForOn" style="width: 200px">Output value for on</label>
        <input type="text" id="node-input-outputValueForOn" style="text-align: left; width: 120px">
        <input type="hidden" id="node-input-outputValueForOntype">
    </div>
    <div class="form-row">
        <label for="node-input-outputValueForOff" style="width: 200px">Output value for off</label>
        <input type="text" id="node-input-outputValueForOff" style="text-align: left; width: 120px">
        <input type="hidden" id="node-input-outputValueForOfftype">
    </div>
        <label for="node-input-sendCurrentValueWhenRescheduling" style="width:300px">
        <input type="checkbox"
               id="node-input-sendCurrentValueWhenRescheduling"
               style="display:inline-block; width:22px; vertical-align:top;"
               autocomplete="off"><span>Send when rescheduling</span>
        </label>
    </div>
    <div class="form-row">
        <label for="node-input-outputIfNoSchedule"  style="width: 200px">If no schedule, send</label>
        <input type="text" id="node-input-outputIfNoSchedule" style="width: 80px">
        </label>
    </div>
    <h3>Context storage</h3>
    <div class="form-row">
      <label for="node-input-contextStorage"  style="width: 200px"><i class="fa fa-archive"></i> Context storage</label>
      <input type="text" id="node-input-contextStorage" style="width: 160px">
  </div>
</script>

<script type="text/markdown" data-help-name="ps-strategy-best-save">
  A node you can use to save money by turning off and on a switch based on power prices.

  Please read more in the [node documentation](https://powersaver.no/nodes/ps-strategy-best-save)
</script>
